\documentclass{article}[fleqn,12pt]
\usepackage{amsmath}
\usepackage{enumitem}
\usepackage{bm}
\usepackage{blindtext}
\usepackage{scrextend}
\usepackage{geometry}
\usepackage{fancyhdr}
\usepackage{graphicx}
\geometry{letterpaper}

\begin{document}
\title{Formulation of the linear optimization model in Owl}
\author{Martin-D. Lacasse}
\maketitle
\thispagestyle{fancy}
\fancyfoot[R]{\copyright\ Martin-D. Lacasse - 2024}
\fancyhead{}

This document describes the mathematical model undelying
the optimization algorithms implemented in
Owl. This code is a Python application optimizing retirement
planning using linear programming. The goal of
these calculations is to optimize the financial aspects
of retirement planning, considering the types of savings accounts,
income tax, contributions, return rates, Roth conversions,
and desired income amongst many other things.

The approach is described here mathematically and the implementation
follows the structure and notation presented in this document.
The goal of this document is to provide a guide to the Python code
intended for any individual desiring to extend the model to other cases.

In the first sections, the indices, variables, and parameters are
described in detail. Then the model constraints are introduced.
For implementation in a linear programming solver, index mapping
functions are proposed to map all variables into a single
one-dimensional array that
is optimized subject to inequality and equality constraints
expressed in matrix form. Finally, the contraint matrices are built
and so are some useful objective functions.

\section{Indices}
For all indices, we will follow the C array style (starting at 0),
rather than the traditional mathematical standard starting at 1.
This will facilitate the final
sequential mapping of all the variables into a single one-dimensional array,
and serve as a direct reference for better understanding the code implementation.

The indices used and their range are defined here, while we also
introduce the characteristics and dimensions of the problem.
Upper bounds on indices are indicated by the letter $N$, with the
index name as a subscript, e.g., $N_i$ for index $i$.
\begin{description}[leftmargin=4em,style=multiline]
\item [$i$]
	Individual. $i$ runs from 0 to $N_i - 1$ where $N_i = 2$ for couples,
	or $N_i= 1$ for single individuals. The first individual to pass
		is denoted by $i_d$ while the survivor is $i_s$.
\item [$j$]
	Type of savings account. $j$ goes from 0 to $N_j - 1$, for taxable, tax-deferred,
	and tax-exempt accounts respectively. Therefore $N_j = 3$.
\item[$k$]
	Type of asset class. $k$ goes from 0 to $N_k -1 $, for S\&P 500,
	Baa corporate bonds, Treasury notes, and cash, respectively. $N_k = 4$.
	More asset classes could be considered at the cost of increasing
	the complexity of the problem while not generating much more insights.
\item [$n$]
	Year being modeled. $n$ runs from 0 to $N_n-1$, and $N_n$
	is the first year following the passing of all
	individuals in the plan. The time period for all decision variables is annual.
	For spouses, $n_d-1$ is the year in which the first individual passes while
	the survivor will decease in year $N_n-1$ of the plan.
\item [$t$]
	Federal income tax bracket. $t$ goes from 0 to $N_t - 1$, from low to high.
	There are $N_t = 7$ federal income tax brackets.
\end{description}

\section{Variables}
We will use lowercase roman letters to represent variables. All variables are assumed
to take only positive values (positive inequality).
\begin{description}[leftmargin=4em,style=multiline]
\item [$b_{ijkn}$]
	Balance for individual $i$ with asset class $k$ in savings account $j$ at the beginning of year $n$.
\item [$b^+_{ijkn}$]
	Amount to be added to savings account balance value $b$ in order to rebalance asset allocations of
	savings account $j$ across different classes of assets $k$.
\item [$b^-_{ijkn}$]
	Amount to be subtracted from savings account balance value $b$ in order to rebalance asset allocations of
	savings account $j$ across different classes of assets $k$. We use two variables
	to rebalance in order to preserve positivity of the variables.
\item [$d_{ikn}$]
	Deposit of year-$n$ net income surplus in assets $k$ of taxable account of individual $i$.
	Deposit is made at the end of year $n$.
\item [$f_{t n}$]
	Fraction of tax bracket $t$ filled, so that taxable ordinary income $G_n$ can be expressed as
	\begin{eqnarray}
		\label{Eq:Tx1}
		G_n = \sum_t f_{t n}\bar{\Delta}_{t n},\\
		0 \leq f_{t n} \leq 1.
	\end{eqnarray}
	A definition of $\Delta$ can be found in the section describing the parameters below. 
\item [$g_n$]
	Net income in year $n$.
\item [$w_{ijkn}$]
	Withdrawal from assets $k$ in account $j$ belonging to individual $i$ at the end of year $n$.
	For the $(j=1)$ tax-deferred savings account, $w_{i1kn}$ is referred to as a distribution for
	tax purposes as it is a taxable withdrawal.
\item [$x_{ikn}$]
	Roth conversion performed by individual $i$ using asset class $k$ at the beginning of year $n$.
	These events are taxable.
\end{description}

\section{Parameters}
For more easily distinguishing parameters from variables, all parameters will be expressed in Greek letters.
Parameter values are either set by the user, historical data, or by the tax code.
\begin{description}[leftmargin=4em,style=multiline]
\item [$\beta{ij}$]
	Initial balances in savings accounts. These amounts are used to initialize $b_{ijk0}$.
\item [$\tau_{kn}$]
	Annual rate of return for asset class $k$ in year $n$.
	A time series of annual return rates for each class of asset.
	Here, inflation and the rate of return of $(k=3)$ cash are assumed to be the same.
\item [$\gamma_n$]
	Cumulative inflation at the beginning of year $n$ computed as
	\begin{equation}
		\gamma_n = \prod_{n' = 0}^{n-1} (1 + \tau_{3n'}),
	\end{equation}
	with $\gamma_0 := 1$, and where $n'$ is a dummy index.
	Parameters indexed for inflation will be indicated by a bar on top as in $\bar\sigma_n$.
\item [$\sigma_n$]
	Standard deduction. It can be adjusted for inflation as follows
	\begin{equation}
		\bar\sigma_n = \sigma_n \gamma_n,
	\end{equation}
	and can be modified for additional age exemptions after 65 of age, for example.
	It is a simple time series to be provided
	which can include any foreseeable changes in the tax code, or change in filing status due to the
	passing of one spouse for $n\ge n_d$.
\item [$\xi_{n}$]
	Spending profile. This is a time series that multiplies the desired net income. It is $\xi_n =1$ for
	a flat profile, or can be a {\em smile} profile allowing for more money at the start
	of retirement. Parameter
	$\xi_n$ can also contain spending adjustments typically made at the passing of one spouse.
	The {\em smile} can be implemented using a cosine superimposed over a gentle linear increase
	such as in
	\begin{equation}
		\xi_n = 1 + a_1*cos(2n\pi/(N_n-1)) + a_2n/(N_n-1),
	\end{equation}
	and then normalized by factor $N_n/(\sum_n \xi_n )$ to be sum-neutral with respect to a flat profile.
	Values of $a_1 = 15\%$ and $a_2=12\%$ provide curves that are similar to realistic
		spending profiles reported in the literature. See Fig.~\ref{Fig:profile} for an example.
	At the passing of one spouse, both profiles are reduced by a factor $\chi$ for $n \ge n_d$,
	and the normalizing factor needs to be adjusted accordingly.
		\begin{figure}[t]
		\includegraphics{profile.png}
		\caption{\small Example of a spending profile with 15\% cosine factor and a 12\% linear
		profile. \label{Fig:profile}}
		\end{figure}
\item [$\chi$]
	Factor to reduce spending profile after the passing of one spouse. It is typically
	assumed to be 0.6.
\item [$\rho_{in}$]
	Required minimum distribution for individual $i$ in year $n$. Expressed in fractions
	which are determined from IRS tables. Simple if spouses are less than 10 years apart,
	a little more complex otherwise, as the age of both spouses need to be taken into account.
	Current implementation only supports spouses being less that 10 years apart.
\item [$\Gamma_{tn}$]
	Bound for Federal income tax bracket. We define $\Gamma_{(-1)n} := 0$, so that
	$\Gamma_{0n}$ is the upper bound for the 10\% tax bracket in year $n$. As the filing status
	can change for couples, and so can the tax code, there will be changes over $n$.
\item [$\Delta_{tn}$]
	Difference between upper bound $\Gamma_t$ and lower bound $\Gamma_{t-1}$
	of a federal income tax bracket,
	\begin{equation}
		\Delta_{tn} = \Gamma_{tn} - \Gamma_{(t-1)n}.
	\end{equation}
	Once adjusted for inflation,
	the taxable income can be expressed as in Eq.~(\ref{Eq:Tx1}). These data are 7 time series.
	The filing status will change after the death of one spouse ($n \ge n_d$) and so these
	brackets need to be adjusted accordingly.
\item [$\theta_{tn}$]
	Tax rate for tax bracket $t$ in year $n$. Using $N_t$ time series allows to adjust income
	tax rates in foreseeable future.
	For example, in 2024 the rates (in decimal) are .10, .12, .22, .24, .32, .35, and .37.
	It is speculated that the rates will revert back to 2017 rates in 2026 with
	.10, .15, .25, .28, .33, .35, and .396. See Eq.~\ref{Eq:Tax} for its use.
\item [$\alpha_{ijkn}$]
	Desired asset allocation for savings account $j$ of individual $i$ in assets class $k$ during year $n$.
	When specified by the user, allocation ratios typically involve two values, one at the
	beginning of the plan $\alpha_{ijk0}$ and the other at the end
	$\alpha_{ijkN_n-1}$. Then, intermediate values are interpolated either using
	a linear relation,
\begin{equation}
	\alpha_{ijkn} = a + \frac{n}{N_n - 1} (b - a),
\end{equation}
or an s-curve as in
\begin{equation}
	\alpha_{ijkn} = a + \frac{(b - a)}{2}
	(\tanh((n-n_1)/n_2) + 1),
\end{equation}
	where $n_1$ is the number of years ahead when inflection point will occur, and $n_2$ is the
	width (in years) of the transition. Constants $n_1$ and $n_2$ are selected by the user.
	Using $a = \alpha_{ijk0}$ and $b = \alpha_{ijkN_n-1}$ is an approximation as values of $\pm 1$
	are only reached at $\pm \infty$.
	More precise bounds $a'$ and $b'$ can be determined by solving a $2\times 2$ system
	of equations leading to
	\begin{eqnarray}
		a' &=& (a - k_{12}b')/k_{11} \nonumber \\
		b' &=& ((b - (k_{21}/k_{11})a)/(k_{22} - (k_{21}/k_{11})k_{12}),
	\end{eqnarray}
	where
	\begin{eqnarray}
		k_{11} &=& \frac{1}{2}(1 - \tanh((0-n_1)/n_2)) \nonumber \\
		k_{12} &=& \frac{1}{2}(1 + \tanh((0-n_1)/n_2)) \nonumber \\
		k_{21} &=& \frac{1}{2}(1 - \tanh((N_n-1-n_1)/n_2)) \nonumber \\
		k_{22} &=& \frac{1}{2}(1 + \tanh((N_n-1-n_1)/n_2)).
	\end{eqnarray}
	These interpolation functions allow the allocation ratios to gradually change
	or {\em glide} during retirement.

	\begin{figure}[t]
	\includegraphics{allocations.png}
		\caption{\small Example of an allocation portfolio with 60/40\% stocks/bonds 
		transitioning to 70/30\%. \label{Fig:allocations}}
	\end{figure}
	It is also possible to have a coarser granularity on the portfolio by
	having an asset allocation scheme
	defined on a sum of accounts. For example, allocation can be coordinated between accounts
	leading to $\alpha_{ikn}$, or even between spouses as $\alpha_{kn}$.
	For any of these cases, it is assumed that weights are always properly scaled so that
	\begin{eqnarray}
		\sum_{k} \alpha_{ijkn} &=& 1, \nonumber\\
		\text{or} \qquad \sum_{k} \alpha_{ikn} &=& 1, \nonumber\\
		\text{or} \qquad \sum_{k} \alpha_{kn} &=& 1,
	\end{eqnarray}
	depending on the scheme selected.

\item [$\Lambda_{in}$]
	Big-ticket item requested by individual $i$ in year $n$.
	These are large expenses or influx of money
	that can be planned. Therefore, $\Lambda$ can be positive (e.g., sell a house, inheritance)
	or negative (e.g., buy a house, large gifts).
\item [$\pi_{in}$]
	Sum of pension benefits for individual $i$ in year $n$. These amounts are typically
	specified along with the ages at which these benefits begin.
\item [$\zeta_{in}$]
	Social security benefits for individual $i$ in year $n$. Starting age and the passing
	of one individual for spouses will determine the time series. $\bar{\zeta}_{in}$ is
	the same series adjusted for inflation.
\item [$\epsilon_{N_n}$]
	Desired amount to leave as a bequest at the end of the final year of the plan, $N_n-1$,
	which is the beginning of year $N_n$. This amount is the after-tax value of the estate
	for the heirs. See parameter $\nu$.
\item [$\kappa_{ijkn}$]
	Sum of contributions to savings account $j$ made by individual $i$ during year $n$.
	We assume that contributions are made at half-year to balance regular contributions,
	and that individual selects asset class $k$ when depositing. In practice, a contribution
	amount $\kappa_{ijn}$ is specified in which case 
	\begin{equation}
		\kappa_{ijkn} = \alpha_{ijkn}\kappa_{ijn}.
	\end{equation}
\item [$\omega_{in}$]
	Sum of wages obtained by individual $i$ during year $n$.
	Do not confuse wages $\omega$ with withdrawals $w$.
\item [$\mu$]
	Dividend return rate in taxable accounts. Average is little above 2\% for S\&P 500.
\item [$\nu$]
	Heirs income tax rate to be applied on the tax-deferred portion of the estate. This is not an estate tax
	but rather the federal income marginal tax rate for the heirs.
\item [$\phi_j$]
	Fraction of savings account $j$ that is left to surviving spouse $i_s$ as a beneficiary
	at the death of individual $i_d$, the first spouse to pass.
\item [$\psi$]
	Income tax rate on long-term capital gain and qualified dividends, typically 15\%.
\item [$\eta$]
	Spousal ratio for withdrawals.
\end{description}

\section{Intermediate variables}
We use intermediate variables for conciseness or clarity,
but they are ultimately replaced in the final formulation.
All intermediate variables are in uppercase letters.
\begin{description}[leftmargin=4em,style=multiline]
\item [$G_n$]
	Taxable ordinary income in year $n$. Sum of wages, pension, social security benefits, all withdrawals
	from tax-deferred accounts, including Roth conversions, and gains from securities
	(i.e., all gains except those from the $(k=0)$ equities)
	in the ($j=0$) taxable account, including contributions $\kappa$, minus the standard deduction,
	\begin{eqnarray}
		\label{Eq:Tx2}
		G_n &=& \sum_{i} [\omega_{in} + .85\bar\zeta_{in} + \pi_{in}] \nonumber \\
		&& + \sum_{ik} [w_{i1kn} + x_{ikn} +
		(1-\delta(k, 0))(b_{i0kn} + .5\kappa_{i0kn})\tau_{kn}] - \bar{\sigma}_n.
	\end{eqnarray}
	Social security is indexed for inflation and is assumed to be taxed at 85\%.
	We use a discrete Kronecker $\delta$ function for selecting gains from non-equity assets in
	taxable accounts. These gains are taxed as ordinary income.

\item [$Q_n$]
	Qualified dividends and long-term capital gains obtained in year $n$.
	They only involve gains occurring in taxable savings accounts $(j=0)$ that
	were obtained from equities $(k=0)$, or sales of stocks for rebalancing allocations
	in taxable savings account.
	For simplicity, we assume that all sales only generate long-term capital gains and
	that all dividends are qualified, resulting in
	\begin{equation}
		\label{Eq:Qx2}
		Q_n = \sum_{i} \left[(b_{i00n} + .5\kappa_{i00n})\mu +
		(w_{i00n} + b^-_{i00n}){\max(0, \tau_{0n})}\right].
	\end{equation}
	A formulation where only a fraction of dividends are qualified can easily be
	implemented with the addition of another parameter.
	The first terms on the right-hand side represent the amount of equities $(k=0)$ in the $(j=0)$
	taxable savings account plus
	half the yearly contributions. The last terms account for withdrawals $w$ of equities assumed
	to have been purchased a year ago and others $b^-$ sold at the end
	of the year as required for rebalancing the account. It does not account for losses, but a market drop
	would most likely result in stock purchase rather than sale (and therefore $b^- = 0$).
	For withdrawals, we make the assumption of
	selling the most recent stocks which would not be accurate in situations where
	the taxable savings account is being depleted slowly.
\item [$T_n$]
	Amount of income tax paid on taxable ordinary income $G_n$ in year $n$.
	This is the taxes paid on ordinary income expressed as the sum of the amounts
	paid in each tax bracket as
	\begin{equation}
		\label{Eq:Tax}
		T_n = \sum_t f_{tn}\bar{\Delta}_{tn}\theta_{tn}.
	\end{equation}
	Notice that $G_n$ is also defined by Eq.~(\ref{Eq:Tx1}), and that optimal
	values of $f_{tn}$ have to
	minimize $T_n$ when either the bequest or the desired net income are maximized.
	As the product $\bar{\Delta}_{tn}\theta_{tn}$ does not garrantee that the tax brackets
	will be favored monotonically, a more natural choice is to use the combined variable
	$\bar{F}_{tn} = f_{tn}\bar{\Delta}_{tn}$ in the optimization. Given that the rates on
	tax brackets $\theta_{tn}$ are always increasing monotonically, we are then naturally
	filling in the lower brackets first when optimizing. In that case
		\begin{equation}
			T_n = \sum_t \bar{F}_t \theta_{tn}.
		\end{equation}
\item [$U_n$]
	Amount of income tax paid on long-term capital gains and qualified dividends in year $n$,
	\begin{equation}
		U_n = \psi Q_n.
	\end{equation}
	Although it is not always the case, we assume that qualified dividends and long-term
	capital gains are taxed at the same preferential rate $\psi$.
\end{description}

\section{Constraints}
\paragraph*{Required minimum distributions (RMDs)}
	Withdrawals from the ($j=1$) tax-deferred savings accounts must be larger
	or equal than the required minimum distributions, therefore
	\begin{equation}
		\label{Eq:C1}
		\sum_k [w_{i1kn} -  \rho_{in}b_{i1kn}] \geq 0.
	\end{equation}
	As $b_{ijkn}$ are the balances at the beginning of year $n$, they are also the balances
	at December 31 of the previous year, which is the amount from which the IRS bases the RMD.
	Eq.~\ref{Eq:C1} has to hold for each year $n$ and each individual $i$, and therefore, there
	are $i\times N_n$ such equations (even when $\rho_{in} = 0$).
	These constraints avoid paying the 50\% penalty
	on amounts not withdrawn when RMDs are required.
	Note that aggregate rules need to be considered separately as this approach only considers
	the sum of assets in a class with similar tax treatment (e.g., IRA and 401k).

\paragraph*{Income tax brackets}
	Taxable ordinary income is divided in tax brackets as defined in Eq.~(\ref{Eq:Tx1}), i.e.,
	\begin{eqnarray}
		\label{Eq:C2}
		G_n = \sum_t f_{tn}\bar{\Delta}_{tn} ,\nonumber\\
		0 \leq f_{tn} \leq 1.
	\end{eqnarray}
	Given this definition, all bracket fractions $f$ must be positive and smaller than or equal to 1,
	imposing an upper bound on $f$.
	Because $\theta_{t} > \theta_{t'}$ when $t > t'$, we can exploit
	this monotonically increasing series to fill the lower
	tax brackets using the minimization algorithm.
	For that purpose, we need to introduce the combined variable
	\begin{equation}
		\bar{F}_{tn} = f_{tn}\bar{\Delta}_{tn},
	\end{equation}
	implying that
	\begin{equation}
		G_n = \sum_t \bar{F}_{tn},
	\end{equation}
	with
	\begin{equation}
		\bar{F}_{tn} \le \bar{\Delta}_{tn}.
	\end{equation}

\paragraph*{Account balances}
	Contributions are assumed to be made at half-year to better represent periodic contributions
	made throughout the year. As we already mentioned,
	the account balance at the end of a year is the same as the balance
	at the beginning of the following year.
	Changes include contributions $\kappa$, distributions and withdrawals $w$,
	conversions $x$, and growth $\tau$.
	We track each asset class $k$ in each savings account $j$ separately.
	Roth conversions are assumed to be made at the beginning of the year, while withdrawals
	and surplus deposits, if needed, are made at the end of the year.
	Accounts are rebalanced using $b^{\pm}$ at the end of the year.
	Timing controls which terms get multiplied by the rate of return $(1 + \tau)$
	of this particular asset.
	Therefore,
	\begin{eqnarray}
		\label{Eq:C3a}
		b_{ijk(n+1)} &=& [b_{ijkn} + (\delta(j, 2) - \delta(j, 1))x_{ikn} 
		+ .5\kappa_{ijkn}](1 + \tau_{kn})
		\nonumber \\
		&& 
		+\ b^+_{ijkn} - b^-_{ijkn} 
		+ .5 \kappa_{ijkn} - w_{ijkn} + \delta(j, 0)d_{ikn},
	\end{eqnarray}
	where we use discrete Kronecker $\delta$ functions for selecting the specific accounts involved
	in Roth conversions. These conversions leave the asset classes unchanged, which can lead to a
	change in allocation ratios in the savings accounts involved. But these changes
	can be corrected by rebalancing variables $b^\pm$ as
	specific allocation ratios have been imposed.

	Bringing all variables
	to the left-hand side, this gets rewritten as
	\begin{eqnarray}
		\label{Eq:C3}
		b_{ijk(n+1)} - [b_{ijkn} + (\delta(j, 2) - \delta(j, 1))x_{ikn}](1 + \tau_{kn})
		&& \nonumber \\
		- \ b^+_{ijkn} + b^-_{ijkn} 
		+ w_{ijkn}
		- \delta(j, 0)d_{ikn} 
		&=& \kappa_{ijkn} \left(1 + \tau_{kn}/2\right).
	\end{eqnarray}

	For each year, there is a degeneracy between a withdrawal from a tax-deferred account and a
	Roth conversion followed by a withdrawal from a tax-tree account. To resolve this degeneracy,
	we re-characterize the latter as a distribution by defining the following variable
	\begin{eqnarray}
		z_{in} &=& min(x_{in}, w_{i2n}), \nonumber \\
		b_{i1n} &=& b_{i2n} + z_{in}, \nonumber \\
		b_{i2n} &=& b_{i2n} - z_{in}, \nonumber \\
		x_{in} &=& x_{in} - z_{in}, \nonumber \\
		w_{i1n} &=& w_{i2n} + z_{in}, \nonumber \\
		w_{i2n} &=& w_{i2n} - z_{in}, 
	\end{eqnarray}
	which entails voiding the Roth conversion and shifting the withdrawal from the
	tax-free account to the tax-deferred account. This step is performed after the
	optimization.

	There is also another null space involving a tax-free withdrawal in the last year
	followed by a deposit in the taxable account. This can also easily be removed
	by giving a slightly higher weight to the tax-free balance in the objective function.

	The initial savings account balances are imposed through additional constraints as
	\begin{eqnarray}
		\label{Eq:InitialBalance}
		b_{ijk0} = \alpha_{ijk0}\beta_{ij},
	\end{eqnarray}
	where we applied the initial allocation ratios $\alpha$ on the initial account balances $\beta_{ij}$.

	It is also possible to eliminate the account balance variables $b$ through iterative
	substitutions, leading to
	\begin{eqnarray}
		\label{Eq:C3c}
		b_{ijkN} &=& b_{ijk0}\prod_{q=0}^{N-1} (1 + \tau_{kq})
		+ (\delta(j, 2) - \delta(j, 1)) \sum_{n=0}^{N-1} 
		x_{ikn} \prod_{q=n+1}^{N-1} (1 + \tau_{kq})
		\nonumber \\
		&&+ \sum_{n=0}^{N-1} \kappa_{ijkn}(1 + \tau_{kn}/2)\prod_{q=n+1}^{N-1} (1 + \tau_{kq})
		\nonumber \\
		&& + \sum_{n=0}^{N-1} [ b^+_{ijkn} - b^-_{ijkn} - w_{ijkn} + \delta(j, 0) d_{ikn}]
		\prod_{q=n+1}^{N-1} (1 + \tau_{kq}),
	\end{eqnarray}
	where $b_{ijk0}$ are the initial balances in year 0, and $\prod_{N}^{N-1} := 1$. This form
	highlights the fact that each amount, either withdrawn or deposited, can be accounted
	for arithmetically when taking into account the compounding effects of annual rates.

	The amounts $b^{\pm}$ used for rebalancing must preserve money in each account $j$, every year $n$,
	and for each individual $i$, and therefore
	\begin{equation}
		\sum_k b^+_{ijkn} = \sum _k b^-_{ijkn},
	\end{equation}
	leading to the constraints
	\begin{equation}
		\label{Eq:NoNewMoney}
		\sum_k [b^+_{ijkn} - b^-_{ijkn}] = 0.
	\end{equation}
	When rebalancing, accounts cannot be negative, so we enforce the additional, and maybe
	unnecessary constraints that
	\begin{equation}
		\label{Eq:EnoughMoney}
		b_{ijkn} - b^-_{ijkn} \geq 0.
	\end{equation}

	The initial balances $\beta_{ij}$ are one of the main inputs of this model. They are
	enforced as a constraint that depends on the asset allocation scheme chosen.
	For {\em account} prescribed allocations,
	\begin{equation}
		\label{Eq:AccountCoord}
		b_{ijk0} =  \alpha_{ijk0}\beta_{ij},
	\end{equation}
	while for {\em individual} coordination between accounts,
	\begin{equation}
		\sum_j b_{ijk0} = \alpha_{ik0}\beta_{ij},
	\end{equation}
	and finally, for {\em spouses} type of coordination,
	\begin{equation}
		\label{Eq:SpouseCoord}
		\sum_{ij} b_{ijk0} = \alpha_{k0}\beta_{ij}.
	\end{equation}

	Maintaining the allocation is provided by the rebalancing variables $b^\pm$. After each
	rebalancing activity,
	\begin{equation}
		\label{Eq:Rebalance}
		(b_{ijkn} + b^+_{ijkn} - b^-_{ijkn}) = \alpha_{ijkn}\sum_{k'} b_{ijk'n},
	\end{equation}
	where we used Eq.~\ref{Eq:NoNewMoney}.

\paragraph*{Roth Conversions}
	Roth conversions cannot be larger than the balance in the account:
	\begin{equation}
		x_{ijn} \le b_{i1kn}.
	\end{equation}
	This constraint, however, is naturally satisfied when $b_{ijkn}$ is enforced.
	Additional constraints $x_{max}$ can be imposed on conversions and then the previous equation
	becomes
	\begin{equation}
		x_{ijn} \le \min(b_{i1kn}, x_{max}).
	\end{equation}

\paragraph*{Net income}
	For calculating the net income $g$, we consider the cash flow of all withdrawals,
	wages, social security and pension benefits, and big-ticket items. 
	Then we subtract potential surplus deposits $d$ made to the taxable savings account
	and all taxes paid:
	\begin{eqnarray}
		g_n = \sum_i [\omega_{in} + \bar{\zeta}_{in} + \pi_{in} ] 
		+ \sum_{ijk} w_{ijkn} + \sum_i \Lambda_{in} - \sum_{ik}d_{ikn}
		- T_n - U_n.
	\end{eqnarray}
	Note that big-ticket items $\Lambda$ can be negative or positive.

	Replacing intermediate variables and bringing all variables to the left-hand side, we get
	\begin{eqnarray}
		\label{Eq:C4}
		g_n - \sum_{ijk} w_{ijkn} + \sum_{ik}d_{ikn}
		+ \sum_t \bar{\Delta}_{t n}\theta_{t n} f_{t n}&&\nonumber \\
		+ \psi \sum_{i} \left[\mu b_{i00n} + (w_{i00n} + b^-_{i00n})
		\max(0, \tau_{0n})\right] 
		&= & \sum_i [\omega_{in} + \bar{\zeta}_{in} + \pi_{in} ] \nonumber\\
		&& + \sum_i [\Lambda_{in} - .5\mu\psi\kappa_{i00n}].
	\end{eqnarray}
	Note that we do not consider market losses as we use $\max(0, \tau)$. Tax-loss
	harvesting is beyond the scope of this model.

	We also want the net income to be predictable and smooth. We will use
\begin{equation}
	\label{Eq:C5a}
	g_{n}/\bar{\xi}_{n} = g_0/\bar{\xi}_0,
\end{equation}
where the net income is adjusted for inflation and where we introduced parameter $\xi_n$ 
allowing for additional adjustments to the overall desired spending.
Note that $\bar{\xi}_0 = \xi_0$ as $\gamma_0=1$.
This spending profile can also be used to lower the desired income at the passing
of one spouse and/or to allow for more realistic spending profiles.
Eq.~(\ref{Eq:C5a}) can be rewritten as
\begin{equation}
	\label{Eq:C5}
	g_n \xi_0 - g_0 \bar{\xi}_n = 0,
\end{equation}
for the constraints to be enforced. Once $g_0$ is determined, the whole time series of net income
is determined.

\paragraph*{Taxable ordinary income}
	We connect the two definitions for $G_n$ stated above in Eqs.~(\ref{Eq:Tx1}) and (\ref{Eq:Tx2}),
	\begin{eqnarray}
		\sum_t f_{t n}\bar{\Delta}_{t n} &=&
		\sum_i [\omega_{in} + .85\bar\zeta_{in} + \pi_{in}]  \nonumber \\
		&& + \sum_{ik} [w_{i1kn} + x_{ikn} + (1 - \delta(k, 0))(b_{i0kn} +
		.5\kappa_{i0kn})\tau_{kn}] - \bar{\sigma}_n,
	\end{eqnarray}
	and re-arrange to move variables to the LHS as follows
	\begin{eqnarray}
		\label{Eq:C6}
		\sum_t \bar{\Delta}_{t n} f_{t n}
		%\nonumber \\
		- \sum_{ik} [
			w_{i1kn} + x_{ikn} +
			(1 - \delta(k, 0))\tau_{kn}b_{i0kn}] &=&
		\sum_i [\omega_{in} + .85\bar\zeta_{in} + \pi_{in} ] 
		- \bar{\sigma}_n
		\nonumber \\
		&& + .5\sum_{ik} [(1-\delta(k, 0))\tau_{kn}\kappa_{i0kn}].
	\end{eqnarray}

\section{Mapping of indices}
At this point, one can use one of the many algebraic modeling languages
such as AMPL, GAMS, AIMMMS, and Gurobi, and code the equations above
using that language, but of these applications are
proprietary and require a license.
These languages allow the problem to be stated at a high level and
steps to cast the problem in a form suitable for solution are performed automatically.
There are also object-oriented language extensions, such as Python's Pyomo
and PuLP that ease the process of solving these problems.
For completeness, however, we present here a simple
index mapping approach that allow solving this problem using a generic
linear programming solver.

To cast the problem in a form suitable for a linear programming solver, we will use
a single block vector represented by the array $y[q()]$ with index-mapping functions $q()$.
While this process can be achieved using slicing and reshaping in some programming
languages, we will present a generic approach suitable for most programming languages.

The detailed approach presented here also allows us to determine the size of the problem to solve.
We proceed alphabetically for all variables, and continue to use the convention of having
index 0 for representing the first element.

First we define two generic mapping functions as
\begin{equation}
	q_*(C, \ell_1, \ell_2, \ell_3, \ell_4; N_1, N_2, N_3, N_4) :=
	C + \ell_1N_2N_3N_4 + \ell_2N_3N_4 + \ell_3N_4 + \ell_4,
\end{equation}
and
\begin{equation}
	q_C(C, N_1, N_2, N_3, N_4) :=
	C + N_1N_2N_3N_4,
\end{equation}
with the constraint that $0 \le \ell_i < N_i$.

\paragraph*{Account balances (\boldmath$b$)}
For storing the savings account balances appropriately, variable $b_{ijkn}$ needs to have one
more entry $(N_n + 1)$ to
store the end-of-life estate value. Therefore, we use
\begin{equation}
	y[q_b(i, j, k, n)] = b_{ijkn},
\end{equation}
where
\begin{equation}
	\label{Eq:Extra}
	q_b(i, j, k, n) = q_*(C_b, i, j, k, n; N_i, N_j, N_k, N_n+1)
\end{equation}
and where $n$ exceptionally runs from 0 to $N_n$ inclusively, and therefore
$q_b$ runs from $C_b = 0$ to $C_{b^+} - 1$,
where
\[
	C_{b^+} = q_C(C_b, Ni, N_j, N_k, N_n+1) = [N_i N_j N_k (N_n+1)].
\]

\paragraph*{Rebalancing amounts (\boldmath$b^\pm$)}
We have similar mappings for $b^\pm$ except for the range of indices,
\begin{equation}
	y[q_{b^\pm}(i, j, k, n)] = b^\pm_{ijkn},
\end{equation}
where
\begin{equation}
	q_{b^\pm}(i, j, k, n) = q_*(C_{b^\pm}, i, j, k, n; N_i, N_j, N_k, N_n),
\end{equation}
and where
$q_{b^+}$ runs from $C_{b^+}$ to $C_{b^-} - 1$,
where
\[
	C_{b^-} = q_C(C_{b^+}, N_i, N_j, N_k, N_n) = [N_i N_j N_k (2N_n + 1)],
\]
while
$q_{b^-}$ runs from $C_{b^-}$ to $C_d - 1$, where
\[
	C_d = q_C(C_{b^-}, N_i, N_j, N_k, N_n) = [N_i N_j N_k  (3N_n + 1)].
\]

\paragraph*{Surplus deposits (\boldmath$d$)}
For the surplus deposits in the taxable savings accounts $d_{ikn}$ we will use
\begin{equation}
	y[q_d(i, k, n)] = d_{ikn},
\end{equation}
where
\begin{equation}
	q_d(i, k, n) = q_*(C_d, i, k, n, 0; N_i, N_k, N_n, 1)
\end{equation}
with $q_d$ running from $C_d$ to $C_f - 1$, where
\[
	C_f = q_C(C_d, N_i, N_k, N_n, 1) = [N_iN_jN_k(3N_n+1) + N_iN_kN_n].
\]

\paragraph*{Tax bracket fractions (\boldmath$f$)}
For tax bracket fractions $f_{t n}$ we will use
\begin{equation}
	y[q_f(t, n)] = f_{t n},
\end{equation}
where
\begin{equation}
	q_f(t, n) = q_*(C_f, t, n, 0, 0; N_t, N_n, 1, 1)
\end{equation}
with $q_f$ running from $C_f$ to $C_g - 1$, where
\[
	C_g = q_C(C_f, N_t, N_n, 1, 1) = [N_iN_jN_k(3N_n+1) + (N_iN_k + N_t) N_n].
\]

\paragraph*{Net income (\boldmath$g$)}
For net income $g_{n}$ we will use
\begin{equation}
	y[q_g(n)] = g_{n},
\end{equation}
where
\begin{equation}
	q_g(n) = q_*(C_g, n, 0, 0, 0; N_n, 1, 1, 1) = C_g + n,
\end{equation}
with $q_g$ running from $C_g$ to $C_w - 1$, where
\[
	C_w = q_C(C_g, N_n, 1, 1, 1) = [N_iN_jN_k(3N_n+1) + (N_iN_k + N_t + 1) N_n].
\]

\paragraph*{Withdrawals (\boldmath$w$)}
For withdrawals $w_{ijkn}$ we will use
\begin{equation}
	y[q_w(i, j, k, n)] = w_{i j k n},
\end{equation}
where
\begin{equation}
	q_w(i, j, k, n) = q_*(C_w, i, j, k, n; N_i, N_j, N_k, N_n)
\end{equation}
with $q_w$ running from $C_w$ to $C_x - 1$, where
\[
	C_x = q_C(C_w, N_i, N_j, N_k, N_n) = [N_iN_jN_k(4N_n + 1) + (N_iN_k + N_t + 1) N_n].
\]

\paragraph*{Roth conversions (\boldmath$x$)}
Finally, for Roth conversions $x_{ikn}$ we will use
\begin{equation}
	y[q_x(i, k, n)] = x_{i k n},
\end{equation}
where
\begin{equation}
	q_x(i, k, n) = q_*(C_x, i, k, n, 0; N_i, N_k, N_n, 1)
\end{equation}
with $q_x$ running from $C_x$ to $C_* - 1$, where
\[
	C_* = q_C(C_x, Ni, N_k, N_n, 1) = [N_iN_jN_k(4N_n + 1) + (2N_iN_k + N_t + 1) N_n].
\]

With $N_i = 2, N_j = 3, N_k = 4, N_t = 7$ we have $120N_n + 24$ variables. For
a 30-year plan, this results in 3,624 variables. If the time resolution is increased to
months, that would result in 43,488 variables which is still solvable by today's standards.

\subsection{Reverse mapping of indices}
The inverse functions for the index-mapping functions will be derived for the
most complex case encountered in this paper.
If we have
\begin{equation}
	z = q_*(C, i, j, k, n; N_i, N_j, N_k, N_n) := C + iN_jN_kN_n + jN_kN_n + kN_n + n,
\end{equation}
then $(i, j, k, n) = q_*^{-1}(z; N_i, N_j, N_k, N_n, C)$ is obtained from
\begin{eqnarray}
	n &=& \texttt{mod}(\texttt{mod}(\texttt{mod}(z - C, N_jN_kN_n), N_kN_n), N_n), \nonumber \\
	k &=& \texttt{mod}(\texttt{mod}(z - C - n, N_jN_kN_n), N_kN_n)/N_n, \nonumber \\
	j &=& \texttt{mod}(z - C - n - kN_n, N_jN_kN_n)/(N_kN_n), \nonumber \\
	i &=& (z - C - n - kN_n - jN_kN_n)/(N_jN_kN_n).
\end{eqnarray}
While this holds for all cases presented in the previous section, this can be easily simplified
for cases having fewer active indices. However, some modern languages can accomplish this
mapping rather easily by providing \texttt{reshape()} functions.

\section{Building constraint matrices}
Let's first define generic index-mapping functions $I$ and $J$ as
\begin{eqnarray}
	\label{Eq:Offsets}
	I_l(n) &=& C_l + n, \nonumber \\
	I_l(i, n; N_n) &=& C_l + iN_n + n, \nonumber \\
	I_l(i, j, n; N_j, N_n) &=& C_l + iN_j N_n + jN_n +n, \\
	\ldots &=& \ldots \nonumber
\end{eqnarray}
and so on, which would cumulatively increase row count $C_l$ at each new instance $l$,
similar to how we proceeded in the previous section.
This allows us to build rectangular matrices by iteratively adding rows.
These constraint matrices have
$C_* = [N_iN_jN_k(4N_n + 1) + (2N_iN_k + N_t + 1) N_n]$
columns but will have less rows,
forming an underdetermined system to be optimized using linear programming.

\subsection{Inequality constraints}

\paragraph*{Required minimum distributions (RMDs)}
We rewrite the inequality constraint on required minimum distributions
Eq.~(\ref{Eq:C1}) using matrix $A_{u}y \le u$ starting with the following $N_iN_n$ rows, 
\begin{eqnarray}
	A_u[I_0(i, n), q_w(i, 1, k, n)] &=& -1 \nonumber \\
	A_u[I_0(i, n), q_b(i, 1, k, n)] &=& \rho_{in}, \nonumber \\
	u[I_0(i, n)] &=& 0, \\
	&&\qquad\forall i \in \{0,\ldots, N_i-1\}, \nonumber\\
	&&\qquad\forall k \in \{0,\ldots, N_k-1\}, \nonumber\\
	&&\qquad\forall n \in \{0,\ldots, N_n -1\},\nonumber
\end{eqnarray}
and all other elements in the same rows of $A_u$ being $0$.
Notice that while $b$ has $N_n+1$ elements, the constraints
for $b$ go from $0$ to $N_n-1$ as there is no RMD required in the last year of the plan $N_n$.
See Eq.~(\ref{Eq:Extra}).

\paragraph*{Income tax brackets}
Similarly, we add $N_t N_n$ more rows to matrix $A_uy \le u$ to express
the inequality constraint in Eq.~(\ref{Eq:C2})
setting an upper limit on fractions $f_{t n} \le 1$. Therefore,
\begin{eqnarray}
	A_u[I_1(t, n), q_f(t, n)] &=& 1, \nonumber \\
	u[I_1(t, n)] &=& 1,\\
	&&\qquad\forall t \in \{0,\ldots, N_t-1\}, \nonumber\\
	&&\qquad\forall n \in \{0,\ldots, N_n -1\},\nonumber
\end{eqnarray}
and all other elements in the same rows of $A_u$ being $0$.

\paragraph{Account rebalance}
For Eq.~(\ref{Eq:EnoughMoney}), where we ensure that the
rebalancing amounts do not overdraw, we add $N_iN_jN_kN_n$ rows to the upper-bound
inequality matrix $A_uy\le u$,
\begin{eqnarray}
	A_u[I_2(i, j, k, n), q_{b}(i, j, k, n)] &=& -1, \nonumber \\
	A_u[I_2(i, j, k, n), q_{b^-}(i, j, k, n)] &=& 1, \nonumber \\
	u[I_2(i, j, k, n)] &=& 0, \\
	&&\qquad\forall i \in \{0,\ldots, N_i-1\},\nonumber\\
	&&\qquad\forall j \in \{0,\ldots, N_j-1\},\nonumber\\
	&&\qquad\forall k \in \{0,\ldots, N_k-1\},\nonumber\\
	&&\qquad\forall n \in \{0,\ldots. N_n-1\}. \nonumber
\end{eqnarray}

\subsection{Equality constraints}

\paragraph*{Account balances}
For the equality constraint on account balances expressed in Eq.~(\ref{Eq:C3}),
we will define an equality constraint matrix $A_ey = v$ starting
with $N_iN_jN_kN_n$ rows as
\begin{eqnarray}
	\label{Eq:B1}
	A_e[J_0(i, j, k, n), q_b(i, j, k, n+1)] &=& 1, \nonumber \\
	A_e[J_0(i, j, k, n), q_b(i, j, k, n)] &=& -(1 + \tau_{kn}), \nonumber \\
	A_e[J_0(i, j, k, n), q_x(i, k, n)] &=& -(\delta(j, 2) - \delta(j, 1))(1 + \tau_{kn}), \nonumber \\
	A_e[J_0(i, j, k, n), q_{b^+}(i, j, k, n)] &=& -1, \nonumber \\
	A_e[J_0(i, j, k, n), q_{b^-}(i, j, k, n)] &=&  1, \nonumber \\
	A_e[J_0(i, j, k, n), q_w(i, j, k, n)] &=& 1, \nonumber \\
	A_e[J_0(i, j, k, n), q_d(i, k, n)] &=& -\delta(j, 0), \\
	&&\qquad\forall i \in \{0,\ldots, N_i-1\},\nonumber\\
	&&\qquad\forall j \in \{0,\ldots, N_j-1\},\nonumber\\
	&&\qquad\forall k \in \{0,\ldots, N_k-1\},\nonumber\\
	&&\qquad\forall n \in \{0,\ldots, N_n-1\}, \nonumber
\end{eqnarray}
where $v$ is
\begin{equation}
	v[J_0(i, j, k, n)] = \kappa_{ijkn}(1 + \tau_{kn}/2).
\end{equation}
The initial account balances expressed in Eq.~\ref{Eq:InitialBalance} are imposed through
\begin{eqnarray}
	A_e[J_1(i, j, k), q_b(i, j, k, 0)] &=& 1, \nonumber \\
	v[J_1(i, j, k)] &=& \beta_{ijk},  \\
	&&\qquad\forall i \in \{0,\ldots, N_i-1\},\nonumber\\
	&&\qquad\forall j \in \{0,\ldots, N_j-1\},\nonumber\\
	&&\qquad\forall k \in \{0,\ldots, N_k-1\},\nonumber
\end{eqnarray}
leading to $N_i N_j N_k$ additional rows to $A_e$.

For the constraint on rebalancing variables  $b^\pm$ expressed in Eq.~(\ref{Eq:NoNewMoney}),
we add $N_iN_jN_n$ more rows to $A_ey = v$, as
\begin{eqnarray}
	A_e[J_2(i, j, n), q_{b^+}(i, j, k, n)] &=& 1, \nonumber \\
	A_e[J_2(i, j, n), q_{b^-}(i, j, k, n)] &=& -1, \nonumber \\
	v[J_2(i, j, n)] &=& 0, \\
	&&\qquad\forall i \in \{0,\ldots, N_i-1\},\nonumber\\
	&&\qquad\forall j \in \{0,\ldots, N_j-1\},\nonumber\\
	&&\qquad\forall k \in \{0,\ldots, N_k-1\},\nonumber\\
	&&\qquad\forall n \in \{0,\ldots. N_n-1\}. \nonumber
\end{eqnarray}

\paragraph*{Net income}
For the equality constraint on net income expressed in Eq.~(\ref{Eq:C4}),
we add $N_n$ more rows to $A_ey = v$ as
\begin{eqnarray}
	A_e[J_3(n), q_g(n)] &=& 1, \nonumber \\
	A_e[J_3(n), q_w(i, j ,k, n)] &=& -1,\nonumber \\
	A_e[J_3(n), q_d(i, ,k, n)] &=& 1, \nonumber \\
	A_e[J_3(n), q_f(t, n)] &=& \bar\Delta_{t n}\theta_{t n}, \nonumber \\
	A_e[J_3(n), q_b(i, 0, 0, n)] &=& \psi\mu, \nonumber \\
	A_e[J_3(n), q_w(i, 0, 0, n)] &=& \psi\max(0, \tau_{0n})/(1+\max(0, \tau_{0n})), \nonumber \\
	A_e[J_3(n), q_{b^-}(i, 0, 0, n)] &=& \psi\max(0, \tau_{0n})/(1+\max(0, \tau_{0n})), \\
	&&\qquad\forall t \in \{0,\ldots, N_t-1\},\nonumber\\
	&&\qquad\forall i \in \{0,\ldots, N_i-1\},\nonumber\\
	&&\qquad\forall j \in \{0,\ldots, N_j-1\},\nonumber\\
	&&\qquad\forall k \in \{0,\ldots, N_k-1\},\nonumber\\
	&&\qquad\forall n \in \{0,\ldots, N_n-1\}, \nonumber
\end{eqnarray}
where $v$ is
\begin{equation}
	v[J_3(n)] = \sum_i [\omega_{in} + \bar\zeta_{in} + \pi_{in}
	+ \Lambda_{in} - .5\psi\mu\kappa_{i00n}].
\end{equation}

The condition of having a predictable net income expressed as an
equality in Eq.~(\ref{Eq:C5}) adds $N_n-1$ more rows to $A_ey = v$ as
\begin{eqnarray}
	A_e[J_4(n), q_g(0)] &=& -\bar{\xi}_n, \nonumber \\
	A_e[J_4(n), q_g(n)] &=& 1, \nonumber \\
	v[J_4(n)] &=& 0, \\
	&&\qquad\forall n \in \{1,\ldots, N_n\}. \nonumber
\end{eqnarray}

\paragraph*{Taxable ordinary income}
Finally, for the equality constraint in Eq.~(\ref{Eq:C6}) establishing taxable
ordinary income, we add $N_n$ rows to $A_ey = v$ as follows
\begin{eqnarray}
	A_e[J_5(n), q_f(t, n)] &=& \bar{\Delta}_{t n}, \nonumber \\
	A_e[J_5(n), q_w(i, 1, k, n)] &=& -1, \nonumber \\
	A_e[J_5(n), q_x(i, k, n)] &=& -1, \nonumber \\
	A_e[J_5(n), q_b(i, 0, k, n)] &=& -(1-\delta(k, 0))\tau_{kn}, \\
	&&\qquad\forall t \in \{0,\ldots, N_t-1\},\nonumber\\
	&&\qquad\forall i \in \{0,\ldots, N_i-1\},\nonumber\\
	&&\qquad\forall k \in \{0,\ldots, N_k-1\},\nonumber\\
	&&\qquad\forall n \in \{0,\ldots, N_n-1\}, \nonumber
\end{eqnarray}
with
\begin{eqnarray}
	v[J_5(n)] &=& 
	\sum_i [\omega_{in} + .85\bar\zeta_{in}  + \pi_{in}]
	+ .5\sum_{ik} [(1-\delta(k, 0))\tau_{kn}\kappa_{i0kn}]
	- \bar{\sigma}_n.
\end{eqnarray}

So far, $A_u$ has $[(N_iN_jN_k + N_i + N_t)N_n]$ or $33N_n$ rows,
while $A_e$ has $[(N_k+1)N_iN_j + 3)N_n + N_iN_jN_k - 1]$ or $33N_n+23$ rows. For a 30-year
plan, this means about 990 rows for each.

\subsection{Other considerations}
\paragraph*{Beneficiaries}
Tax-exempt and tax-deferred accounts have special tax rules that allow giving part
or the entire value of
tax-exempt accounts to a spouse who can then consider it as his/her own.
Let $\phi_j$ be the fraction of the account $j$ that a spouse $i_d$ wishes
to leave to his/her surviving spouse $i_s$
in the year $n_d < N_n - 1$ of passing. 
To account for that event in year $n_d$, Eq.~(\ref{Eq:C3a}) needs to be rewritten as
\begin{eqnarray}
	b_{ijk(n+1)} &=& (1 - \delta(n, n_d-1)\delta(i, i_d)) \nonumber \\
	&&\times \Bigl\{\left[b_{ijkn} + (\delta(j, 2) - \delta(j, 1))x_{ikn}
	+ .5\kappa_{ijkn}\right](1 + \tau_{kn}) 
	\nonumber \\
	&& +  b^+_{ijkn} - b^-_{ijkn} + .5 \kappa_{ijkn} - w_{ijkn} + \delta(j, 0)d_{ikn} \Bigr\}
	+ (\phi_j\delta(n, n_d-1)\delta(i, i_s)) \nonumber  \\
	&& \times \Bigl\{\left[b_{i_djkn} + (\delta(j, 2) - \delta(j, 1))x_{i_dkn}
	+ .5\kappa_{i_djkn}\right](1 + \tau_{kn}) 
	\nonumber \\
	&& + b^+_{i_djkn} - b^-_{i_djkn} + .5 \kappa_{i_djkn} - w_{i_djkn} + \delta(j, 0)d_{i_dkn}\Bigr\} .
\end{eqnarray}
The first multiplier $()$ on the right-hand side will always be one except for $i_d$ in
year $n_d-1$ when it will be zero. This will result in emptying all accounts for $i_d$ for years
$n_d$ and beyond.
The second special multiplier $()$ before the second set of brackets
$\{\}$ will always be zero except for the surviving
spouse $i_s$ in year $n_d-1$, who will then inherit a fraction $\phi_j$ of account $j$ that
was scheduled to go into $i_d$'s $j$ account at the beginning of year $n_d$.

Rewriting the last equation as a constraint results in
\begin{eqnarray}
	&&b_{ijk(n+1)} 
	  \nonumber  \\
	&& - (1 - \delta(n, n_d-1)\delta(i, i_d)) \nonumber\\
	&& \times \Bigl\{ \left[b_{ijkn} + (\delta(j, 2) - \delta(j, 1))x_{ikn}\right](1 + \tau_{kn}) + b^+_{ijkn} - b^-_{ijkn} - w_{ijkn} + \delta(j, 0)d_{ikn} \Bigr\}
	\nonumber \\
	&&- (\phi_j\delta(n, n_d-1)\delta(i, i_s)) \nonumber \\
	&& \times \Bigl\{ \left[b_{i_djkn} + (\delta(j, 2) - \delta(j, 1))x_{i_dkn}\right](1 + \tau_{kn}) + b^+_{i_djkn} - b^-_{i_djkn} - w_{i_djkn} + \delta(j, 0)d_{i_dkn} \Bigr\}
	\nonumber \\
	&&= \left[ (1 - \delta(n, n_d-1)\delta(i, i_d)) 
	\kappa_{ijkn} + (\phi_j\delta(n, n_d-1)\delta(i, i_s))
	\kappa_{i_djkn}\right](1 + \tau_{kn}/2). \nonumber  \\
\end{eqnarray}
We are now ready to replace Eq.~(\ref{Eq:B1}) for $A_ey = v$ by
\begin{eqnarray}
        \label{Eq:B2}
        A_e[J_0(i, j, k, n), q_b(i, j, k, n+1)] &=& 1, \nonumber \\
        A_e[J_0(i, j, k, n), q_b(i, j, k, n)] &=& - (1 - \delta(n, n_d-1)\delta(i, i_d))
                (1 + \tau_{kn}), \nonumber \\
        A_e[J_0(i, j, k, n), q_x(i, k, n)] &=& - (1 - \delta(n, n_d-1)\delta(i, i_d))
                (\delta(j, 2) - \delta(j, 1))
                (1 + \tau_{kn}), \nonumber \\
        A_e[J_0(i, j, k, n), q_{b^+}(i, j, k, n)] &=& - (1 - \delta(n, n_d-1)\delta(i, i_d)),
                \nonumber \\
	A_e[J_0(i, j, k, n), q_{b^-}(i, j, k, n)] &=&  (1 - \delta(n, n_d-1)\delta(i, i_d)),
                \nonumber \\
        A_e[J_0(i, j, k, n), q_w(i, j, k, n)] &=& (1 - \delta(n, n_d-1)\delta(i, i_d)), \nonumber \\
        A_e[J_0(i, j, k, n), q_d(i, j, n)] &=& - (1 - \delta(n, n_d-1)\delta(i, i_d))
                \delta(j, 0), \nonumber \\
		\text{when $N_i =2$ and $i = i_s$} && \nonumber\\
        A_e[J_0(i, j, k, n), q_b(i_d, j, k, n)] &=& - (\phi_j\delta(n, n_d-1)\delta(i, i_s))
                (1 + \tau_{kn}), \nonumber \\
        A_e[J_0(i, j, k, n), q_x(i_d, k, n)] &=& - (\phi_j\delta(n, n_d-1)\delta(i, i_s))
                (\delta(j, 2) - \delta(j, 1))
                (1 + \tau_{kn}), \nonumber \\
        A_e[J_0(i, j, k, n), q_{b^+}(i_d, j, k, n)] &=& - (\phi_j\delta(n, n_d-1)\delta(i, i_s)),
                \nonumber \\
        A_e[J_0(i, j, k, n), q_{b^-}(i_d, j, k, n)] &=& (\phi_j\delta(n, n_d-1)\delta(i, i_s)),
                \nonumber \\
        A_e[J_0(i, j, k, n), q_w(i_d, j, k, n)] &=& (\phi_j\delta(n, n_d-1)\delta(i, i_s)),
                \nonumber \\
        A_e[J_0(i, j, k, n), q_d(i_d, j, n)] &=&  -(\phi_j\delta(n, n_d-1)\delta(i, i_s))
                \delta(j, 0), \nonumber \\
        &&\qquad\forall i \in \{0,\ldots, N_i-1\},\nonumber\\
        &&\qquad\forall j \in \{0,\ldots, N_j-1\},\nonumber\\
        &&\qquad\forall k \in \{0,\ldots, N_k-1\},\nonumber\\
        &&\qquad\forall n \in \{0,\ldots, N_n-1\}, \nonumber
\end{eqnarray}
where $v$ is
\begin{equation}
	v[I(i, j, k, n)] 
	= [(1 - \delta(n, n_d)\delta(i, i_d))
	\kappa_{ijkn} + (\phi_j\delta(n, n_d-1)\delta(i, i_s))\kappa_{i_djkn}](1 + \tau_{kn}/2). 
\end{equation}
While the last two equations may look cumbersome, their net effect is only to include
a few more terms when $n=n_d-1$. 

\paragraph*{Assets allocation ratios}
To avoid creating a quadratic problem while rebalancing the accounts, we track the account balances
by asset classes using $b_{ijkn}$. We can then prescribe how to rebalance the accounts.
The values of $b^\pm$ can be governed by prescribed asset allocation ratios $\alpha$ defined as
\begin{equation}
	\label{Eq:Alloc1}
	\alpha_{ijkn} = (b_{ijkn} + b^+_{ijkn} - b^-_{ijkn})/\sum_{k'} b_{ijk'n},
\end{equation}
where $k'$ here is just a dummy index.
These asset allocation ratios can then be imposed as an equality constraint as
\begin{equation}
	\label{Eq:Alloc2}
	b_{ijkn} + b^+_{ijkn} - b^-_{ijkn} - \sum_{k'} \alpha_{ijkn} b_{ijk'n}] = 0,
\end{equation}
which can be written as
\begin{eqnarray}
	\label{Eq:Alloc3}
	A[J_6(i, j, k, n), q_b(i, j, k, n)] &=& 1, \nonumber\\
	A[J_6(i, j, k, n), q_b^+(i, j, k, n)] &=& 1, \nonumber\\
	A[J_6(i, j, k, n), q_b^-(i, j, k, n)] &=& -1, \nonumber\\
	A[J_6(i, j, k, n), q_b(i, j, k', n)] &=& - \alpha_{ijkn}, \nonumber\\
	v[J_6(i, j, k, n)] &=& 0, \\
	&&\qquad\forall i \in \{0,\ldots, N_i-1\},\nonumber\\
	&&\qquad\forall j \in \{0,\ldots, N_j-1\},\nonumber\\
	&&\qquad\forall k,k' \in \{0,\ldots, N_k-1\},\nonumber\\
	&&\qquad\forall n \in \{0,\ldots, N_n-1\}. \nonumber
\end{eqnarray}

There are a few ways in which accounts can be coordinated to match
overall asset allocation ratios.
If one would like to coordinate across all savings accounts of each individual,
using specified asset allocation ratios $\alpha_{ikn}$,
then Eq.~(\ref{Eq:Alloc2}) becomes
\begin{equation}
	\label{Eq:Alloc2a}
	\sum_{jk'} [(\delta(k, k') - \alpha_{ikn}) b_{ijk'n}] = 0,
\end{equation}
leading to
\begin{eqnarray}
	\label{Eq:Alloc3a}
	A[J_6(i, k, n), q_b(i, j, k', n)] &=& \delta(k, k') - \alpha_{ikn}, \nonumber\\
	v[J_6(i, k, n)] &=& 0, \\
	&&\qquad\forall i \in \{0,\ldots, N_i-1\},\nonumber\\
	&&\qquad\forall j \in \{0,\ldots, N_j-1\},\nonumber\\
	&&\qquad\forall k,k' \in \{0,\ldots, N_k-1\},\nonumber\\
	&&\qquad\forall n \in \{0,\ldots, N_n-1\}. \nonumber
\end{eqnarray}
Similarly, if coordination is desired between all savings accounts from both spouses
specified by overall asset allocation ratios $\alpha_{kn}$,
then Eq.~(\ref{Eq:Alloc3a}) becomes
\begin{eqnarray}
	\label{Eq:Alloc3b}
	A[J_6(k, n), q_b(i, j, k', n)] &=& \delta(k, k') - \alpha_{kn}, \nonumber\\
	v[J_6(k, n)] &=& 0, \\
	&&\qquad\forall i \in \{0,\ldots, N_i-1\},\nonumber\\
	&&\qquad\forall j \in \{0,\ldots, N_j-1\},\nonumber\\
	&&\qquad\forall k,k' \in \{0,\ldots, N_k-1\},\nonumber\\
	&&\qquad\forall n \in \{0,\ldots, N_n-1\}, \nonumber
\end{eqnarray}
reducing the number of constraints by $N_iN_j=6$ when compared to Eq.~(\ref{Eq:Alloc3}).

If asset allocation ratios $\alpha$ are imposed,
they should also be applied to how
contributions amounts $\kappa_{ijn}$ are invested, such that 
\begin{equation}
	\kappa_{ijkn} = \alpha_{ijkn} \kappa_{ijn}.
\end{equation}
For other allocation schemes, just substitute $\alpha_{ijkn} = \alpha_{ikn}$ or $\alpha_{kn}$
depending on the scheme selected.

The same approach needs to be applied to surplus deposits, but
in this case, however, it leads to
additional constraints to be imposed,
\begin{equation}
	\sum_{k'} [(\delta(k, k') - \alpha_{i0kn}) d_{ik'n}] = 0,
\end{equation}
adding $N_iN_kN_n$ additional rows to $A_e$.

Assets allocation could have been handled easily by assuming that
the accounts are always rebalanced
and only using a single multiplier $\Xi$, defined as
\begin{equation}
	\Xi_{ijn} = \sum_k \alpha_{ijkn}\tau_{kn},
\end{equation}
to compute to return
on the total balance of each savings account.
However, a benefit of tracking all asset classes in each account separately
is that it allows us to optimize over asset allocations through rebalancing, at
the cost of solving a larger problem. If the constraints in Eq.~(\ref{Eq:Alloc3}),
Eq.~(\ref{Eq:Alloc3a}), or Eq.~(\ref{Eq:Alloc3b})
are not imposed, the allocation ratios would then be optimized according to
the chosen objective function, and calculated using Eq.~(\ref{Eq:Alloc1}).

\paragraph*{Spousal deposits and withdrawals}
In order to keep the problem linear, a simple constraint that can be imposed on
surplus deposits to be made in taxable savings accounts is to specify a spousal ratio $\eta$
such as
\begin{equation}
	d_{0kn} = \eta d_{1kn}.
\end{equation}
A similar spousal ratio can be imposed on withdrawals from tax-deferred accounts
\begin{equation}
	w_{01kn} = \eta w_{11kn},
\end{equation}
but this can cause drawing an account empty while the other spousal account is not.

\section{Objective functions}
The objective function is a simple scalar defined as $c\cdot y$ that will be minimized.

\paragraph*{Maximum net income}
There are a few ways by which a retirement plan can be optimized. For maximizing the net income under
the constraint of a desired bequest, we introduce the following relation
\begin{equation}
	\label{Eq:Bequest}
	E_n = \sum_{ijk} (1 - \nu\delta(j, 1)) b_{ijkn},
\end{equation}
which is the value of the estate in nominal dollars at year $n$,
taking into consideration the heir's marginal income tax rate on the ($j=1$) tax-deferred account. 
In this situation, the concept of surplus deposit is no longer valid, and therefore
\begin{equation}
	d_{ikn} = 0,
\end{equation}
implemented as
\begin{eqnarray}
	A_e[I(6), q_d(i, k, N_n)] &=& 0 \nonumber \\
	v[I(0)] &=& \epsilon_{N_n}\gamma_{N_n} \\
	&&\qquad\forall i \in \{0,\ldots, N_i-1\},\nonumber\\
	&&\qquad\forall k \in \{0,\ldots, N_k-1\},\nonumber\\
	&&\qquad\forall n \in \{0,\ldots, N_n-1\}.\nonumber
\end{eqnarray}

For a desired bequest $\epsilon_{N_n}$, expressed in today's
dollars, the final amount in year $N_n$ will need to be
\begin{equation}
	E_{N_n} = \bar\epsilon_{N_n} = \epsilon_{N_n} \gamma_{N_n}.
\end{equation}
Fixing a bequest value amounts to adding the following constraint
\begin{equation}
	\sum_{ijk} b_{ijkN_n} (1 - \nu\delta(j, 1)) = \epsilon_{N_n} \gamma_{N_n},
\end{equation}
which would add one more row to $A_ey = v$ as
\begin{eqnarray}
	A_e[I(0), q_b(i, j, k, N_n)] &=& (1 - \nu\delta(j, 1)) \nonumber \\
	v[I(0)] &=& \epsilon_{N_n}\gamma_{N_n} \\
	&&\qquad\forall i \in \{0,\ldots, N_i-1\},\nonumber\\
	&&\qquad\forall j \in \{0,\ldots, N_j-1\},\nonumber\\
	&&\qquad\forall k \in \{0,\ldots, N_k-1\},\nonumber
\end{eqnarray}
where $I(0)$ is used only to provide the proper row offset $C_l$. See Eq.~(\ref{Eq:Offsets}).

For maximizing the net income under the constraint of a fixed bequest, one has simply to
minimize the inner product $c\cdot y$, where $c$ is
\begin{eqnarray}
	c[q_g(0)] &=& -1,
\end{eqnarray}
and 0 otherwise. See Eq.~\ref{Eq:C5}.

\paragraph*{Maximum bequest}
If, on the other hand, one would like to maximize the bequest under the constraint of a desired net income $g_o$,
one would add the following row to $A_ey = v$
\begin{eqnarray}
	\label{Eq:FixedIncome}
	A_e[I(0), q_g(0)] &=& 1, \nonumber \\
	v[I(0)] &=& g_o.
\end{eqnarray}

The objective function would then be derived from Eq.~(\ref{Eq:Bequest}) as
minimizing the inner product $c\cdot y$, where $c$ is
\begin{eqnarray}
	\label{Eq:MaxBequest}
	c[q_b(i, j, k, N_n)] &=& -(1 - \nu\delta(j, 1)),\\
	&&\qquad\forall i \in \{0,\ldots, N_i-1\},\nonumber\\
	&&\qquad\forall j \in \{0,\ldots, N_j-1\},\nonumber\\
	&&\qquad\forall k \in \{0,\ldots, N_k-1\},\nonumber
\end{eqnarray}
and 0 otherwise.

\end{document}
